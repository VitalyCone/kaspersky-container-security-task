# Kaspersky Container Security worker pool 
## Описание:
Небольшое API с worker pool. Вшит 20% шанс на ошибку, подкрепляется экспоненциальным бэкоффом с джиттером. 
Сам воркер находится в файле `./internal/workerpool/workerpool.go` со вспомагательными комментариями к функциям и тестами в `./internal/workerpool/workerpool_test.go`
### По заданиям:

#### 1.	Принимать задания через POST /enqueue
В файле `./internal/app/apiserver/apiserver.go` находятся все ручки

#### Тело: JSON {"id":"<string>","payload":"<string>","max_retries":<int>}.
В файле `./internal/domain/dto/task.go` находится модель для тасков

#### Задание попадает в буферизированную очередь (размер — из конфигурации).
в .env файле можно указать размер очереди, по умолчанию 64

#### 2.	Обрабатывать задания пулом воркеров (WORKERS настраивается)
обработка в вышеописанном файле workerpool.go, WORKERS указываются в .env, по умолчанию 4

#### Каждое задание «работает» 100–500 мс (симулируем обработку).
В workerpool.go в функции `w.taskProcess` рандомно берется время между константами minWaitMs и maxWaitMs, 100 и 500 мс соответственно

#### 20% задач «падают» (симулируем ошибки) → должен быть экспоненциальный бэкофф с джиттером и до max_retries повторов.
В workerpool.go 20% задач падают рандомно, после чего повторяется попытка выполнения с экспоненциальным бэкоффом с джиттером, в функции `w.taskProcessWithRetry`

#### Хранить и обновлять состояние: queued | running | done | failed.
Для состояний в workerpool.go я описал константы и функции checkStates, changeState для логирования и обновления состояний. Они работают с каналом taskStates для удобного отслеживания смены состояний

#### 3.	Отдавать healthcheck 
Ручка в вышеописанном `./internal/app/apiserver/apiserver.go`

#### 4.	Корректно завершает программу по SIGINT/SIGTERM
в `./cmd/workerpool/main.go` в функции main() есть обработка сигналов SIGINT/SIGTERM, которая завершает все потоки и завершает программу. Вызывается graceful shutdown в apiserver, а он в свою очередь в workerpool с корректным завершением задач

#### Версия Go 1.24. Без сторонних библиотек.
Сторонние библиотеки в программе не используются, есть только testify для тестирования workerpool

## Запуск:
```
task run # если есть task
```
или
```
go run cmd/workerpool/main.go --port 8080
```

Доступны `localhost:8080/enqueue` и `localhost:8080/healthz`
